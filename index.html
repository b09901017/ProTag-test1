<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 é˜²ç›œç›£æ§</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; transition: background 0.5s; }
    h1 { font-size: 3em; }
    #status { font-size: 2em; margin-top: 20px; }
    .safe { background-color: #e8f5e9; color: #2e7d32; }
    .alarm { background-color: #ffebee; color: #c62828; }
  </style>
</head>
<body class="safe">

  <h1 id="statusText">ç›£æ§ä¸­...</h1>
  <div id="status">ç­‰å¾…é€£ç·š...</div>

  <button id="playBtn" style="display:none; margin-top:30px; padding:20px; font-size:1.5em; background-color:red; color:white; border:none; border-radius:10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
    ğŸ”Š é–‹å•Ÿè­¦å ±è²
  </button>
  
  <audio id="alarmSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" loop></audio>

  <p style="color:gray; font-size:0.8em; margin-top:50px;">
    (è«‹å…ˆé»æ“Šç•«é¢ä»»æ„è™•ä»¥å•Ÿç”¨ç¶²é åŠŸèƒ½)
  </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // é€™è£¡è¨˜å¾—å¡«å›ä½ å‰›å‰›é‚£ä¸€ä¸² config
    const firebaseConfig = {
        apiKey: "AIzaSyATnKODPUhALae4W2eKS87DnGYoWp1qfTQ",
        authDomain: "protag-5888d.firebaseapp.com",
        databaseURL: "https://protag-5888d-default-rtdb.firebaseio.com",
        projectId: "protag-5888d",
        storageBucket: "protag-5888d.firebasestorage.app",
        messagingSenderId: "745205812540",
        appId: "1:745205812540:web:9904001e10f13f95bba239",
        measurementId: "G-PWM2Z4WK2D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const alarmRef = ref(db, 'alarm_status');
    const alarmSound = document.getElementById("alarmSound");
    const playBtn = document.getElementById("playBtn");
    const body = document.body;
    const statusText = document.getElementById("statusText");

    // é€™æ˜¯ç€è¦½å™¨çš„é™åˆ¶ï¼Œä¸€å®šè¦å…ˆé»ä¸€æ¬¡ç¶²é æ‰èƒ½å•Ÿç”¨éœ‡å‹•å’Œè²éŸ³
    document.addEventListener('click', () => {
        // é»æ“Šå¾Œä»€éº¼éƒ½ä¸åšï¼Œåªæ˜¯ç‚ºäº†é¨™å–ç€è¦½å™¨ä¿¡ä»»
        console.log("ç¶²é å·²å•Ÿç”¨");
    }, { once: true });

    // è¨­å®šæŒ‰éˆ•çš„åŠŸèƒ½ï¼šé»äº†æ‰é–‹å§‹å«
    playBtn.addEventListener('click', () => {
        alarmSound.play();
        playBtn.innerText = "ğŸ”• é—œé–‰è²éŸ³"; // æŒ‰ä¸‹å¾ŒæŒ‰éˆ•æ–‡å­—æ”¹è®Š
    });

    onValue(alarmRef, (snapshot) => {
      const data = snapshot.val();
      document.getElementById("status").innerText = "æ„Ÿæ¸¬å€¼: " + data;

      if (data === 1) {
        // --- è­¦å ±è§¸ç™¼ ---
        statusText.innerText = "âš ï¸ è­¦å‘Šï¼šé–€è¢«æ‰“é–‹ï¼";
        body.className = "alarm";

        // 1. åŸ·è¡Œéœ‡å‹• (Android Only)
        // æ¨¡å¼ï¼šéœ‡å‹•500ms -> åœ200ms -> éœ‡å‹•500ms...
        if (navigator.vibrate) {
            navigator.vibrate([500, 200, 500, 200, 500]); 
        }

        // 2. é¡¯ç¤ºæŒ‰éˆ•ï¼Œè®“ä½¿ç”¨è€…æ±ºå®šè¦ä¸è¦æ’­è²éŸ³
        playBtn.style.display = "inline-block";
        playBtn.innerText = "ğŸ”Š é–‹å•Ÿè­¦å ±è²"; // é‡ç½®æŒ‰éˆ•æ–‡å­—

      } else {
        // --- è§£é™¤è­¦å ± ---
        statusText.innerText = "âœ… å®‰å…¨";
        body.className = "safe";
        
        // åœæ­¢è²éŸ³
        alarmSound.pause();
        alarmSound.currentTime = 0;
        
        // éš±è—æŒ‰éˆ•
        playBtn.style.display = "none";
        
        // åœæ­¢éœ‡å‹• (å‚³ 0 å°±æ˜¯åœæ­¢)
        if (navigator.vibrate) {
            navigator.vibrate(0);
        }
      }
    });
  </script>
</body>
</html>