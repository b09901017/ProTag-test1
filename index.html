<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ESP32 é˜²ç›œç›£æ§</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 50px; transition: background 0.5s; }
    h1 { font-size: 3em; }
    #status { font-size: 2em; margin-top: 20px; }
    .safe { background-color: #e8f5e9; color: #2e7d32; }
    .alarm { background-color: #ffebee; color: #c62828; }
  </style>
</head>
<body class="safe">

  <h1 id="statusText">ç›£æ§ä¸­...</h1>
  <div id="status">ç­‰å¾…é€£ç·š...</div>

  <button id="playBtn" style="display:none; margin-top:30px; padding:20px; font-size:1.5em; background-color:red; color:white; border:none; border-radius:10px; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
    ğŸ”Š é–‹å•Ÿè­¦å ±è²
  </button>
  
  <audio id="alarmSound" src="https://www.soundjay.com/buttons/beep-01a.mp3" loop></audio>

  <p style="color:gray; font-size:0.8em; margin-top:50px;">
    (è«‹å…ˆé»æ“Šç•«é¢ä»»æ„è™•ä»¥å•Ÿç”¨ç¶²é åŠŸèƒ½)
  </p>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // é€™è£¡è¨˜å¾—å¡«å›ä½ å‰›å‰›é‚£ä¸€ä¸² config
    const firebaseConfig = {
        apiKey: "AIzaSyATnKODPUhALae4W2eKS87DnGYoWp1qfTQ",
        authDomain: "protag-5888d.firebaseapp.com",
        databaseURL: "https://protag-5888d-default-rtdb.firebaseio.com",
        projectId: "protag-5888d",
        storageBucket: "protag-5888d.firebasestorage.app",
        messagingSenderId: "745205812540",
        appId: "1:745205812540:web:9904001e10f13f95bba239",
        measurementId: "G-PWM2Z4WK2D"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const alarmRef = ref(db, 'alarm_status');
    const alarmSound = document.getElementById("alarmSound");
    const playBtn = document.getElementById("playBtn");
    const body = document.body;
    const statusText = document.getElementById("statusText");

    // ç”¨ä¸€å€‹è®Šæ•¸ä¾†è¨˜éŒ„ç¾åœ¨æ˜¯ä¸æ˜¯æ­£åœ¨æ’­æ”¾è²éŸ³
    let isPlaying = false;

    // è§£æ±ºç€è¦½å™¨é™åˆ¶
    document.addEventListener('click', () => { console.log("ç¶²é å·²å•Ÿç”¨"); }, { once: true });

    // --- ä¿®æ”¹é‡é» 1ï¼šæŒ‰éˆ•è®Šæˆé–‹é—œé‚è¼¯ ---
    playBtn.addEventListener('click', () => {
        if (isPlaying) {
            // å¦‚æœæ­£åœ¨æ’­ -> æš«åœ
            alarmSound.pause();
            playBtn.innerText = "ğŸ”Š é–‹å•Ÿè­¦å ±è²"; // æŒ‰éˆ•è®Šå›é–‹å•Ÿ
            playBtn.style.backgroundColor = "red"; // æ”¹å›ç´…è‰²æé†’å»æŒ‰
            isPlaying = false;
        } else {
            // å¦‚æœæ²’åœ¨æ’­ -> æ’­æ”¾
            alarmSound.play();
            playBtn.innerText = "ğŸ”• é—œé–‰è²éŸ³"; // æŒ‰éˆ•è®Šæˆé—œé–‰
            playBtn.style.backgroundColor = "gray"; // è®Šæˆç°è‰²ä»£è¡¨å·²é–‹å•Ÿ
            isPlaying = true;
        }
    });

    onValue(alarmRef, (snapshot) => {
      const data = snapshot.val();
      document.getElementById("status").innerText = "æ„Ÿæ¸¬å€¼: " + data;

      if (data === 1) {
        // --- è­¦å ±è§¸ç™¼ ---
        statusText.innerText = "âš ï¸ è­¦å‘Šï¼šé–€è¢«æ‰“é–‹ï¼";
        body.className = "alarm";

        if (navigator.vibrate) { navigator.vibrate([500, 200, 500, 200, 500]); }

        // é¡¯ç¤ºæŒ‰éˆ•
        playBtn.style.display = "inline-block";
        // é€™è£¡ä¸è‡ªå‹•æ’­æ”¾ï¼Œä¿æŒå®‰éœï¼Œç­‰ä½¿ç”¨è€…æŒ‰æŒ‰éˆ•

      } else {
        // --- è§£é™¤è­¦å ± (å®‰å…¨) ---
        statusText.innerText = "âœ… å®‰å…¨";
        body.className = "safe";
        
        // åœæ­¢è²éŸ³
        alarmSound.pause();
        alarmSound.currentTime = 0;
        
        // --- ä¿®æ”¹é‡é» 2ï¼šé‡ç½®æ‰€æœ‰ç‹€æ…‹ ---
        playBtn.style.display = "none";
        playBtn.innerText = "ğŸ”Š é–‹å•Ÿè­¦å ±è²"; // é‡ç½®æ–‡å­—
        playBtn.style.backgroundColor = "red"; // é‡ç½®é¡è‰²
        isPlaying = false; // é‡ç½®ç‹€æ…‹è®Šæ•¸
        
        if (navigator.vibrate) { navigator.vibrate(0); }
      }
    });
  </script>
</body>
</html>